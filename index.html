<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Fuzzy Search</title>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/fuzzysort@3.0.1/fuzzysort.min.js"></script>
	<!-- <script type="text/javascript" src="https://rawgit.com/farzher/fuzzysort/master/fuzzysort.js"></script> -->
	<script type="text/javascript" src="snomed.js"></script>
	<script type="text/javascript">
		document.addEventListener("DOMContentLoaded", ignore =>{
			let f = document.getElementById('found')
			let s = document.getElementById('search')
			let t = document.getElementById('typo')
			let o = document.getElementById('old')
			let ca = document.getElementById('case')
			let lim = document.getElementById('limit')
			let fuzzy = document.getElementById('fuzzy')
			let idx = document.getElementById('index')
			let sortedtekst = undefined
			//let sortedtekst = [...snotekst].sort((a, b)=> a.slice(7).localeCompare(b.slice(7)))
			let targets = undefined 

			s.addEventListener("input", e => { if (s.value !== "") search() });

			[t, o, fuzzy, ca, lim].map(el => el.addEventListener("change", e => { if (s.value !== "") search() }))
			let format = (s) => { 
				s = s.slice(-7, -6) === '#' ? `<span style="color:${s.slice(-7)} !important;">${s.slice(0,-7)}</span>` : s
				s = s.slice(-1) === '!' ? `<span class ='old'>${s.slice(0,-1)}</span>` : `${s}`
				return s
			}

			let search = () => {
				let search_string = s.value
				let limit = lim.value
				if (fuzzy.checked) {
					// this branch searches only through fuzzysort
					let options = { limit: limit, allowTypo: t.checked, threshold: -10000 }
					targets = targets || snotekst.map(i => fuzzysort.prepare(i))
					f.innerHTML = fuzzysort.go(search_string, targets, options)
						.map(r => [r, r.target.slice(-1) == "!"])
						.map(([ rz, old ]) => [ rz.highlight(), old ])
						.map(([ rzh, old ]) => `${old ? "<span class=old>" : ""}${rzh.replace("!","")}${old ? "</span>" : ""}`)
						.join('\n')
					// end fuzzysort, code below searches through RegExp and Array.filter
					return
				} 
				if (idx.checked) {
					let index = snotekst.findLastIndex(e=> e.slice(0,search_string.length).localeCompare(search_string, "da-DK") < 0)
					let beginning = index > 10 ? index - 10 : 0
					let end = index + 10 > snotekst.length ? snotekst.length : index + 10
					f.innerHTML = snotekst.slice(beginning, end)
						.map(s => format(s))
						.toSpliced(index - beginning + 1, 0, search_string + '\t <----')
						.join('\n')
					return
				}
				let found = 0
				let caseSensitive = ca.checked ? "": "i"
				let r, rs, r0
				try {
					r = RegExp(`(${search_string})`, caseSensitive)
					rs = RegExp(`^(${search_string})`, caseSensitive)
					r0 = RegExp(`^([A-Æ]?${search_string})`, caseSensitive)
				} catch (e) {
					console.log(e.message)
					s.style.color = "firebrick"
					return
				}
				s.style.color = "inherit"
				//f.innerHTML = snotekst.filter(s => (s.startsWith(search_string) || s.startsWith(search_string, 7)) && found++ < limit)
				let result = snotekst.filter(s => (r0.test(s) && found++ < limit))
					.filter(s => !(o.checked && s.slice(-1) === '!'))
					.map(s => format(s))
				if (found < limit) {
					result.push(...snotekst.filter(s => (rs.test(s.slice(7))) && found++ < limit)
						.sort((a,b)=> a.slice(0,7).localeCompare(b.slice(0,7)))
						.filter(s => !(o.checked && s.slice(-1) === '!'))
						.map(s => {
							s = s.slice(0,7).concat(s.slice(7).replace(rs, "<b>$1</b>"))
							s = format(s)
							return s
						})
					)
				}
				if (found < limit) {
					sortedtekst = sortedtekst || [...snotekst].sort((a, b)=> { 
						a.slice(7).localeCompare(b.slice(7))
					})
					result.push(...sortedtekst.filter(s => (r.test(s.slice(8))) && found++ < limit)
						.map(s => [s, r.exec(s).index])
						.sort((a, b) => a[1]>b[1])
						.map(a => a[0] )
						.filter(s => !(o.checked && s.slice(-1) === '!'))
						.map(s => format(s))
					)
				}
				f.innerHTML = result.join('\n')
				if(found >= limit) f.innerHTML = `<b>${found} results, truncated to ${limit}</b>\n\n` + f.innerHTML
				console.log(`${found} results`)
			}
		})
	</script>
	<style type="text/css">
		#search {
			width: 500px;
		}
		#limit {
			width: 50px;
		}
		input[type=checkbox]:checked~#found>.old {
			display:none;
		}
		#found {
			margin-top: 20px;
			font-family: Courier New, monospace;
			font-size: 10pt;
			line-height: 1.3em;
		}
		.old {
			color: #a8a8a8;
		}
	</style>
</head>
<body>
	<p><label for="search">Find PatoSNOMED kode</label>
	<input type="text" id="search"></p>
	<p>
		<label for="limit">Max</label>
		<input type="number" id="limit" value="150"> resultater&nbsp;&nbsp;

		<input type="checkbox" id="fuzzy">
		<label for="fuzzy">Fuzzy søgning</label>
		<input type="checkbox" id="typo">
		<label for="typo">Også med forvekslede bogstaver</label>
		<input type="checkbox" id="old">
		<label for="old">Skjul udgåede diagnoser</label>
		<input type="checkbox" id="case">
		<label for="case">Case sensitive</label>
		<input type="checkbox" id="index">
		<label for="index">Find placering til ny kode</label>
	</p>
	<pre id="found"></pre>
</body>
</html>
